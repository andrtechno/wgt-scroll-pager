var IASHistoryExtension=function(e){return e=jQuery.extend({},this.defaults,e),this.ias=null,this.prevSelector=e.prev,this.prevUrl=null,this.listeners={prev:new IASCallbacks(jQuery)},this.onPageChange=function(e,t,r){if(window.history&&window.history.replaceState){var i=history.state;history.replaceState(i,document.title,r)}},this.onScroll=function(e,t){var r=this.getScrollThresholdFirstItem();this.prevUrl&&(e-=this.ias.$scrollContainer.height())<=r&&this.prev()},this.onReady=function(){var e=this.ias.getCurrentScrollOffset(this.ias.$scrollContainer),t=this.getScrollThresholdFirstItem();(e-=this.ias.$scrollContainer.height())<=t&&this.prev()},this.getPrevUrl=function(e){return e||(e=this.ias.$container),jQuery(this.prevSelector,e).last().attr("href")},this.getScrollThresholdFirstItem=function(){var e;return 0===(e=this.ias.getFirstItem()).length?-1:e.offset().top},this.renderBefore=function(e,t){var r=this.ias,i=r.getFirstItem(),n=0;r.fire("render",[e]),jQuery(e).hide(),i.before(e),jQuery(e).fadeIn(400,(function(){++n<e.length||(r.fire("rendered",[e]),t&&t())}))},this};IASHistoryExtension.prototype.initialize=function(e){var t=this;this.ias=e,jQuery.extend(e.listeners,this.listeners),e.prev=function(){return t.prev()},this.prevUrl=this.getPrevUrl()},IASHistoryExtension.prototype.bind=function(e){e.on("pageChange",jQuery.proxy(this.onPageChange,this)),e.on("scroll",jQuery.proxy(this.onScroll,this)),e.on("ready",jQuery.proxy(this.onReady,this))},IASHistoryExtension.prototype.unbind=function(e){e.off("pageChange",this.onPageChange),e.off("scroll",this.onScroll),e.off("ready",this.onReady)},IASHistoryExtension.prototype.prev=function(){var e=this.prevUrl,t=this,r=this.ias;if(!e)return!1;r.pause();var i=r.fire("prev",[e]);return i.done((function(){r.load(e,(function(e,i){t.renderBefore(i,(function(){t.prevUrl=t.getPrevUrl(e),r.resume(),t.prevUrl&&t.prev()}))}))})),i.fail((function(){r.resume()})),!0},IASHistoryExtension.prototype.defaults={prev:".prev"};
